# Документация по смарт-контрактам экосистемы ALFA

## ALFAKey
### Назначение
`ALFAKey` — невзаимозаменяемый токен (ERC-721), который хранит «тип» каждого токена и количество токенов данного типа. Контракт используется как база ключей для других подсистем (хранилище, forge и т. д.).

### Роли и права
- `DEFAULT_ADMIN_ROLE` — полные права конфигурации.
- `MINTER_ROLE` — минт новых ключей.
- `BURNER_ROLE` — сжигание ключей по адресу владельца.
- `EDITOR_ROLE` — управление каталогом типов ключей (создание, изменение, удаление).

При деплое все роли выдаются создателю, а набор типов предзаполняется пятью вариантами (Green Gorilla, Blue Cobra, Yellow Bear, Red Tiger, Violet Dragon) с привязкой к медиаресурсам.

### Структуры данных и состояние
- `_types` — множество идентификаторов типов.
- `_typeName`, `_typeURI`, `_typeCount` — метаданные по типам и текущее число токенов каждого типа.
- `_tokenType` — тип конкретного токена.
- `_holderTokens`, `_holderAmounts` — ускорители для пагинации токенов держателя и подсчёта их количества по типам.

### Основные сценарии работы
- **Чтение**: `getTypes`, `getTokens`, `tokenType`, `getTypeAmount`, `getTypeHolderAmount`, `getHolderAmounts` позволяют строить интерфейсы без полного перебора всех токенов.
- **Минт**: `mint(receiver, typeId)` создаёт токен указанного типа и обновляет счётчики.
- **Сжигание**: `burn(holder, tokenId)` проверяет владельца и корректирует балансы.
- **Переход прав собственности**: переопределение `_update` обновляет статистику при любом трансфере, минте или сжигании.

### Администрирование и события
- `addType`, `removeType`, `updateType` формируют каталог типов.
- События `TypeAdded/Removed/Updated`, `TokenMinted`, `TokenBurned` отражают изменения каталога и обращения с токенами.

## ALFALootbox
### Назначение
`ALFALootbox` — ERC-721 для лутбоксов. Каждый тип лутбокса содержит таблицу выпадений (`DropChance`) с указанием адреса NFT, типа награды и вероятности. При открытии лутбокса он сжигается, а награда минтится через указанный контракт.

### Роли и права
- `DEFAULT_ADMIN_ROLE`, `MINTER_ROLE`, `BURNER_ROLE`, `EDITOR_ROLE` — аналогично `ALFAKey`.
- Админ в конструкторе настраивает пять типов лутбоксов (Common, Rare, Epic, Legendary, Mystic) и предопределённые распределения наград.

### Структуры данных и состояние
- `_typeDrop` — массивы вероятностей выпадения для каждого типа.
- `_tokenType`, `_typeCount`, `_holderTokens`, `_holderAmounts` — зеркальное хранение состояния, как в `ALFAKey`.
- `_randomCounter` — дополнительная соль для псевдослучайного выбора.

### Основные сценарии работы
- **Чтение**: `getTypes`, `getTokens`, `tokenType`, `getHolderAmounts` и др. возвращают метаданные и статистику.
- **Минт/сжигание**: `mint` и `burn` доступны ролям минтера и сжигателя.
- **Открытие**: `open(tokenId)` доступен владельцу; `openFor(holder, tokenId)` — операторам с ролью `BURNER_ROLE`. Метод `_open` генерирует псевдослучайное число, выбирает запись из `_typeDrop` и вызывает `mint` на целевом NFT-контракте. Лутбокс затем уничтожается.

### Администрирование и события
- `addType`, `removeType`, `updateType` изменяют каталог типов.
- `clearDrop` очищает таблицу выпадений выбранного типа.
- `_addDrop` используется для расширения таблиц (публичного интерфейса нет).
- События `TypeDropAdded`, `TypeDropCleared`, `DropRolled`, `TokenMinted/Burned` покрывают ключевые действия.

## ALFAReferral
### Назначение
`ALFAReferral` поддерживает дерево реферальных связей и таблицу процентов вознаграждений по уровням. Используется магазином и forge для распределения платежей.

### Роли и права
- `DEFAULT_ADMIN_ROLE` — изменение процента вознаграждений.
- `CONNECTOR_ROLE` — управление отношениями (создание и обновление цепочек).

При деплое обе роли получает создатель. Базовые проценты по уровням: 80%, 40%, 20%, 10%, 10% (масштабированы через `PERCENT_PRECISION`).

### Структуры данных и состояние
- `_parents` — отображение ребёнок → родитель.
- `_children` — наборы детей на каждого родителя с возможностью пагинации.
- `_percents` — массив долей по уровням (можно заменить админом).

### Основные сценарии работы
- `getPercents` и `getReferralPercents(child)` возвращают конфигурацию долей и конкретную цепочку для адреса.
- `getParent`, `getChildrenCount`, `getChildren` предоставляют навигацию по дереву с пагинацией.
- `addRelation` связывает пару (родитель, ребёнок), предварительно удаляя старые связи.
- `setSequence` принимает массив `[child, parent1, parent2, ...]` и выстраивает цепочку до существующего родителя или конца массива, контролируя длину.
- `setPercents` обновляет массив процентов и эмитит `PercentsSet`.

### События
`RelationAdded`, `RelationRemoved`, `PercentsSet` позволяют отслеживать обновления графа и конфигурации наград.

## ALFAVault
### Назначение
`ALFAVault` хранит набор поддерживаемых токенов (ERC-20 или нативный BNB) и распределяет накопленные средства между владельцами «мастер-ключей» (`ALFAKey` с типом `_masterKeyTypeId`). Контракт фиксирует окно погашения (unlock / redeemUntil) и после него позволяет администратору изымать остатки.

### Роли и права
- `DEFAULT_ADMIN_ROLE` — управление списком токенов, датами, мастер-ключом и выводом средств.

### Структуры данных и состояние
- `_tokens` — множество разрешённых токенов; `address(0)` обозначает нативный BNB.
- `_keys` — ссылка на контракт `ALFAKey` для получения количества ключей и проверки типов.
- `_masterKeyTypeId` — тип ключа, дающий право на погашение (по умолчанию 5).
- `unlockDate`, `redeemUntilDate` — границы окна, в течение которого держатели могут забирать награды.

### Основные сценарии работы
- `redeem(tokenId)` доступен держателям мастер-ключей. Метод проверяет тип ключа и текущее время, равномерно распределяет текущий баланс каждого разрешённого токена между всеми мастер-ключами (`amount = balance / totalKeys`), переводит долю держателю, эмитит `RewardRedeemed` и сжигает ключ.
- `getVaultTokens`, `getInfo`, `getHolderShare`, `getKeysTotalAmount`, `getTokenAvailable` предоставляют агрегированную аналитику.

### Администрирование и события
- `addToken` / `removeToken` управляют разрешёнными активами.
- `setMasterKey`, `setUnlockDate`, `setRedeemUntilDate` перенастраивают условия погашения.
- `withdraw` (три перегрузки) выводит средства после окончания окна `redeemUntilDate`.
- События `TokenAdded/Removed`, `MasterKeySet`, `UnlockDateSet`, `RedeemUntilDateSet`, `RewardRedeemed`, `RewardWithdrawn` отображают операции с конфигурацией и активами.

## ALFAStore
### Назначение
`ALFAStore` продаёт лутбоксы `ALFALootbox` по ценам, выраженным в USDT. Покупатели могут платить разрешёнными токенами или BNB; контракт запрашивает котировки через PancakeSwap V2, распределяет платежи между рефералами, командой и хранилищем.

### Зависимости
- `vault` (`IALFAVault`) — источник списка доступных токенов и получатель доли проекта.
- `lootBox` (`IALFALootbox`) — целевой контракт для минта лутбоксов.
- `_referral` (`ALFAReferral`) — расчёт реферальных выплат.
- PancakeSwap V2 router (`router`) — получение курсов.

### Роли и права
- `DEFAULT_ADMIN_ROLE` — управление ценами, долей хранилища, адресом команды.
- Команда по умолчанию — деплойер (`teamAccount`).
- Доля хранилища стартует с 80% (`vaultShare = 800_000` от `PERCENT_PRECISION`).

### Структуры данных и состояние
- `_prices[typeId]` — цена лутбокса в единицах USDT (raw decimals).
- В конструкторе можно передать массив цен; если он пустой, устанавливается дефолтная ступенчатая сетка (0, 1, 10, 100, 1 000, 10 000 USDT).

### Основные сценарии работы
- `getPrices` возвращает двумерную матрицу котировок: для каждого типа лутбокса и каждого токена из `vault.getVaultTokens()` вычисляется требуемое количество токена с использованием `router.getAmountsOut` (с fallback через WBNB для ERC-20 и отдельный расчёт для BNB).
- `buy(typeId, tokenAddress, boxAmount, parents)` — покупка за ERC-20. Проверяет, что продажи ещё не открыты (время до `vault.unlockDate()`), тип и цена доступны, токен разрешён, баланс и allowance хватает. Реферальная последовательность обновляется (если передана), затем платеж распределяется (`_distributePayment`) и минтятся лутбоксы.
- `buy(typeId, boxAmount, parents)` — аналогичный сценарий для BNB. Контракт проверяет `msg.value`, распределяет оплату, возвращает излишек покупателю (или пересылает в `vault`, если возврат не удался).

### Распределение платежей
Метод `_distributePayment` обходит цепочку рефералов (`_referral.getReferralPercents(holder)`), перечисляя доли в соответствии с `PERCENT_PRECISION`. После выплаты рефералам оставшаяся доля сравнивается с `vaultShare`: превышение переводится на `teamAccount`, остаток — в `vault`. События `ReferralRewardSent`, `TeamRewardSent`, `VaultRefilled` фиксируют выплаты.

### Администрирование и события
- `setPrices`, `setVaultShare`, `setTeamAccount` управляют экономикой магазина.
- События `PriceSet`, `VaultShareSet`, `TeamAccountSet`, `LootBoxSold` позволяют отслеживать активность.

## ALFAForge
### Назначение
`ALFAForge` реализует механизмы улучшения ключей `ALFAKey`: пользователь оплачивает апгрейд, исходный ключ сжигается, после чего с определённой вероятностью минтится ключ более высокого ранга. Контракт повторно использует реферальную модель распределения и ценовую логику магазина.

### Зависимости
- `key` (`IALFAKey`) — источник типов ключей, операций минта/сжигания и проверки владельца.
- `vault` (`IALFAVault`) — проверка временного окна (продажи недоступны после `unlockDate`) и адрес для форварда возвратов.
- `_referral` (`ALFAReferral`) — расчёт реферальных долей.
- PancakeSwap V2 router — получение котировок.

### Роли и права
- `DEFAULT_ADMIN_ROLE` — управление ценами, долями, аккаунтами и списком токенов.
- `EDITOR_ROLE` — зарезервирован для расширений (в текущей версии публичных методов с этим ограничением нет).
- `teamAccount` — деплойер по умолчанию.
- `burnAccount` — адрес, куда переводится доля «сжигания» (передаётся в конструктор).
- `burnShare` — доля burn-аккаунта (по умолчанию 80%).

### Структуры данных и состояние
- `_tokens` — множество разрешённых платёжных токенов (включая `address(0)` для BNB); на момент деплоя пустой, требуется заполнение отдельными административными транзакциями (в коде отсутствуют публичные методы добавления/удаления).
- `_discount[token]` — индивидуальная скидка на оплату конкретным токеном.
- `_prices[typeId]` — стоимость апгрейда в USDT-эквиваленте (индекс 0 не используется).
- `_typeDrop[typeId]` — таблица вероятностей перехода в новый тип (0 означает отсутствие новой награды).
- `_randomCounter` — дополнительная соль для псевдослучайного выбора.

### Основные сценарии работы
- `getPrices` формирует матрицу котировок по разрешённым токенам и ценам.
- `upgrade(tokenId, tokenAddress)` — апгрейд с оплатой в ERC-20: метод `_pay` проверяет, что вызывающий владеет ключом, что продажи ещё закрыты (`block.timestamp < vault.unlockDate()`), находит цену (с учётом индивидуальной скидки), проверяет баланс/allowance и распределяет оплату (`_distributePayment`). Далее `_upgrade` сжигает исходный ключ, выбирает выпадение из `_typeDrop`, и если `typeId > 0`, минтит новую версию ключа.
- `upgrade(tokenId)` (payable) — аналогичный сценарий для оплаты BNB с возвратом излишка.

> ⚠️ После вызова `key.burn(holder, tokenId)` контракт обращается к `key.tokenTypeId(tokenId)` для получения исходного типа. Реализация ключей должна поддерживать такой вызов после burn (например, за счёт хранения типа без проверки владельца), иначе апгрейд завершится неудачей.

### Распределение платежей
Метод `_distributePayment` повторяет логику магазина, но остаток после рефералов и команды переводит на `burnAccount`, эмитя `BurnAccountRefilled`.

### Администрирование и события
- `setPrices`, `setBurnShare`, `setBurnAccount`, `setTeamAccount`, `setTokenDiscount` управляют экономикой апгрейдов.
- События `TypeDropAdded`, `PriceSet`, `TokenDiscountSet`, `ReferralRewardSent`, `TeamRewardSent`, `BurnAccountRefilled`, `KeyUpgraded`, `KeyBurned` фиксируют изменения конфигурации и результаты апгрейдов.
